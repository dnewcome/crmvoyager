
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>CRM Voyager</title>
  <meta name="author" content="Dan Newcome">

  
  <meta name="description" content="I ran across a Javascript library today called MSCRM 4.0 Web Service Toolkit for making calls to CRM from Javascript. Apparently it was inpired by &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://crmvoyager.net/blog/page/8/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="CRM Voyager" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10833846-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">CRM Voyager</a></h1>
  
    <h2>Navigating the high seas of Microsoft CRM.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:crmvoyager.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>

<div id="adsense" style="border: 1px solid black">
	<script type="text/javascript"><!--
		google_ad_client = "ca-pub-5305300577407644";
		/* CRM Voyager */
		google_ad_slot = "1427166023";
		google_ad_width = 728;
		google_ad_height = 90;
		//-->
		</script>
		<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
	</script>
</div>

  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/06/07/consuming-crm-web-services-from-javascript/">Consuming CRM Web Services From Javascript</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-06-07T21:46:17-07:00" pubdate data-updated="true">Jun 7<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I ran across a Javascript library today called <a href="http://danielcai.blogspot.com/2010/01/crm-web-service-javascript-toolkit.html">MSCRM 4.0 Web Service Toolkit </a>for making calls to CRM from Javascript. Apparently it was inpired by <a href="http://www.ercantuzun.com/post/Ascentium-CrmService-JavaScript-Library.aspx">this library</a>. This sure beats hand rolling soap calls, and is CRM specific, unlike some <a href="http://www.guru4.net/articoli/javascript-soap-client/en/">other Javascript soap clients</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/06/02/error-registering-workflow-to-disk/">Error Registering Workflow to Disk</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-06-02T16:06:45-07:00" pubdate data-updated="true">Jun 2<span>nd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The other day I was working on a CRM workflow activity that I had registered to the database with the plugin registration tool. Later on, I wanted to register the same assembly to disk for easy debugging, but I was confronted with the following exception when trying to register the assembly:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Unhandled Exception: System.Web.Services.Protocols.SoapException: Server was unable to process request.
</span><span class='line'>Detail: &lt;detail&gt;&lt;error&gt;
</span><span class='line'>  &lt;code&gt;0x80044191&lt;/code&gt;
</span><span class='line'>  &lt;description&gt;Assembly can not be loaded from C:<span class="se">\P</span>rogram Files<span class="se">\M</span>icrosoft Dynamics CRM<span class="se">\s</span>erver<span class="se">\b</span>in<span class="se">\a</span>ssembly<span class="se">\M</span>yWorkflow.dll.&lt;/description&gt;
</span></code></pre></td></tr></table></div></figure>


<p>I thought that maybe I had to run the registration tool as administrator since the path was under `program files&#8217;, but this did not help.</p>

<p>It isn&#8217;t obvious from the docs, but they mention that you are responsible for copying the assemblies to the target folder under C:\Program Files\Microsoft Dynamics CRM\server\bin\assembly. However, it doesn&#8217;t work unless you copy the assembly beforehand, and point the tool to that location when registering the assembly. You can&#8217;t register the assembly from another location and then copy the binary afterward.</p>

<p>This limitation is mentioned in the documentation for plugin registration <a href="http://msdn.microsoft.com/en-us/library/cc151098.aspx">here</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/05/21/fixing-intractable-crm-workflow-errors/">Fixing Intractable CRM Workflow Errors</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-21T15:01:18-07:00" pubdate data-updated="true">May 21<span>st</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I was having issues adding a custom workflow activity to one of my workflows today, and everything seemed right but I still was seeing an error in the CRM trace output when adding the activity to a new workflow.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[2010-05-21 10:49:35.3] Process: w3wp |Organization:11a5abbd-36aa-de11-8729-00155d00050c |Thread:   25 |Category: Application |User: 00000000-0000-0000-0000-000000000000 |Level: Error | ErrorInformation.LogError
</span><span class='line'>&gt;MSCRM Error Report:
</span><span class='line'>--------------------------------------------------------------------------------------------------------
</span><span class='line'>Error: Field 'Altai.Workflow.ContractActivity.FtpPasswordProperty' not found.</span></code></pre></td></tr></table></div></figure>


<p>I checked and double checked and that field is certainly there. I used Reflector to check the code in the actual assembly.</p>

<p>Finally, I renamed the assembly and reimported and the error was resolved. Apparently there is some caching going on behind the scenes that was the root of my issue.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/05/19/dependency-properties-rant/">Dependency Properties Rant</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-19T21:26:48-07:00" pubdate data-updated="true">May 19<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><ul>
<li>Update:
I ran into these issues when testing the activity classes outside of a workflow runtime context. It turns out that there is more to this than I thought. Once running inside of CRM we don&#8217;t have the name collision issue. However, I wasn&#8217;t able to put common properties in a superclass, so apparently trying to test workflows outside of CRM only works in certain cases.</li>
</ul>


<p>When I first looked at Windows Workflow Foundation and WPF back when .net 3.0 hit RTM I thought that dependency properties were confusing. Or at the very least over-complex. Probably both. As I looked further into WPF and saw the XAML magic that they enabled I guess I eased up a little bit. I thought I understood them pretty fully until today when I was writing a suite of workflow activities for MS CRM.</p>

<p>My development work was moving along swimmingly, and the test cases of my first activity were passing with flying colors. As I started in on testing the rest of the activities I ran into some issues.</p>

<p>I got the following runtime error following the successful run of the tests on the first activity and before the second:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unhandled Exception: System.TypeInitializationException: The type initializer for 'Altai.Workflow.ContractActivity' threw an exception. ---&gt; System.InvalidOperationException: DependencyProperty 'FtpPassword' could not be registered.  A property with the same name already exists for type 'Altai.Workflow.VendorActivity'.
</span><span class='line'>   at System.Workflow.ComponentModel.DependencyProperty.ValidateAndRegister(String name, Type propertyType, Type ownerType, PropertyMetadata defaultMetadata, Type validatorType, Boolean isRegistered)</span></code></pre></td></tr></table></div></figure>


<p>Since the dependency property boilerplate code is so verbose, I used codegen to spit out all of the properties that I needed. I figured I made a mistake when running my codegen tool and specified the same type name for the properties on both of the activity classes. I double checked everything and it turned out that everything looked fine. On a hunch I changed the names given to the properties so that they were unique and the error was replaced by a new error:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Unhandled Exception: System.TypeInitializationException: The type initializer for 'Altai.Workflow.VendorActivity' threw an exception. ---&gt; System.ArgumentException: Type 'Altai.Workflow.VendorActivity' does not define a static dependency property with name 'PVAFtpPasswordProperty'.</span></code></pre></td></tr></table></div></figure>


<p>So it looks like the properties are looked up by the <strong>string name alone. </strong>This surprised me since we give the .net type when we register the property. Really I don&#8217;t know what Microsoft was thinking with this one. Not only are dependency properties globally registered using a static registry, they don&#8217;t use the registered type to disambiguate potential conflicts in field names.</p>

<p>To restate my displeasure here, not only are we referencing the registered properties using a string and ignoring the type info provided, <strong>we are doing so lazily at runtime when the type initializers for the class are running. </strong>This is one of those cases where type safety is just an illusion, and really only serves to trip us up while simultaneously providing a false sense of security.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/05/19/testing-windows-workflow-activities-in-isolation/">Testing Windows Workflow Activities in Isolation</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-19T19:48:47-07:00" pubdate data-updated="true">May 19<span>th</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>There comes a time in every CRM developer&#8217;s career when he&#8217;s tired of doing the rain dance of plugin re-registration for testing custom workflow activities. Of course, moving all of the heavy lifting out of the actual Execute() method is a must, but sometimes we just need to test the thing as-is.</p>

<p>I&#8217;ve seen <a href="http://msdn.microsoft.com/en-us/magazine/dd179724.aspx">some references</a> to testing workflow activities on the web that recommend using the workflow runtime to spin things up for the test, but for smoke testing individual activities, I think that this is probably overkill. What I&#8217;m going to do here is to spin up an instance of the activity outside of the WF runtime environment. For another take on this as well as a sample of spinning up the actual WF runtime for testing, check out <a href="http://odetocode.com/blogs/scott/archive/2006/08/02/unit-testing-workflow-activities.aspx">this reference</a>. Of course, if we have a composite activity or if we reach into the execution context at all, this technique won&#8217;t work. If need be I might look at mocking the execution context, but for now I don&#8217;t need it.</p>

<p>As an example, take the following custom CRM workflow activity that sends a notification to a web service with a contract ID that has been updated in CRM</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ContractUpdateActivity</span> <span class="p">:</span> <span class="n">Activity</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">static</span> <span class="n">DependencyProperty</span> <span class="n">ContractNumberProperty</span> <span class="p">=</span>
</span><span class='line'>        <span class="n">DependencyProperty</span><span class="p">.</span><span class="n">Register</span><span class="p">(</span>
</span><span class='line'>            <span class="s">&quot;ContractNumber&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span> <span class="kt">string</span> <span class="p">),</span>
</span><span class='line'>            <span class="k">typeof</span><span class="p">(</span><span class="n">ContractUpdateActivity</span> <span class="p">)</span>
</span><span class='line'>        <span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="na">    [CrmInput(&quot;ContractNumber&quot;)]</span>
</span><span class='line'>    <span class="k">public</span> <span class="kt">string</span> <span class="n">ContractNumber</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">get</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">(</span> <span class="kt">string</span> <span class="p">)</span><span class="k">base</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span> <span class="n">ContractNumberProperty</span> <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">set</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">base</span><span class="p">.</span><span class="n">SetValue</span><span class="p">(</span> <span class="n">ContractNumberProperty</span><span class="p">,</span> <span class="k">value</span> <span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">protected</span> <span class="k">override</span> <span class="n">ActivityExecutionStatus</span> <span class="nf">Execute</span><span class="p">(</span> <span class="n">ActivityExecutionContext</span> <span class="n">executionContext</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">Service</span> <span class="n">service</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Service</span><span class="p">();</span>
</span><span class='line'>        <span class="n">service</span><span class="p">.</span><span class="n">ContractUpdated</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="n">ContractNumber</span> <span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">ActivityExecutionStatus</span><span class="p">.</span><span class="n">Closed</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Even though this is far from being a unit test or free of side effects, we&#8217;d still like to run this activity as a smoke test outside of CRM. There are two potential problems with doing something like</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ContractUpdateActivity</span> <span class="n">updateActivity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContractUpdateActivity</span><span class="p">();</span>
</span><span class='line'><span class="n">updateActivity</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span> <span class="k">null</span> <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>The most obvious issue, were one to attempt compilation of the above code, is that the Execute() method is protected and not visible to us in a test. Fortunately, Execute() is defined on System.Workflow.ComponentModel.Activity which intended for use as a base class and is not sealed.</p>

<p>So, instead of using ContractUpdateActivity directly in our test, we can make a small wrapper by subclassing it:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">ContractUpdateActivityTest</span> <span class="p">:</span> <span class="n">ContractUpdateActivity</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">base</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span> <span class="k">null</span> <span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>now we can write a few lines of code to exercise the code (I hesitate to call this a &#8216;test&#8217;) via the subclass:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">ContractUpdateActivityTest</span> <span class="n">testUpdateActivity</span> <span class="p">=</span> <span class="k">new</span> <span class="n">ContractUpdateActivityTest</span><span class="p">();</span>
</span><span class='line'><span class="n">testUpdateActivity</span><span class="p">.</span><span class="n">ContractNumber</span> <span class="p">=</span> <span class="s">&quot;12345&quot;</span><span class="p">;</span>
</span><span class='line'><span class="n">testUpdateActivity</span><span class="p">.</span><span class="n">Execute</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>The other issue to watch for is that of dependencies. The type initializer of Activity tries to load dependencies behind the scenes and won&#8217;t look in the current path of the executable that is running the test. The required classes must either be compiled into the same assembly as the workflow activity or be found in the GAC. It may be possible to locate the assemblies somewhere else, but I haven&#8217;t looked at the fusion logs to find out where else workflow looks for assemblies.</p>

<p>If an assembly is not found, the .net runtime will issue an error similar to the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">System</span><span class="p">.</span><span class="n">TypeLoadException</span><span class="p">:</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">load</span> <span class="n">type</span> <span class="err">&#39;</span><span class="n">Service</span><span class="err">&#39;</span> <span class="k">from</span> <span class="n">assembly</span> <span class="err">&#39;</span><span class="n">ContractServices</span><span class="p">,</span> <span class="n">Version</span><span class="p">=</span><span class="m">4.0</span><span class="p">.</span><span class="m">0.0</span><span class="p">,</span> <span class="n">Culture</span><span class="p">=</span><span class="n">neutral</span><span class="p">,</span> <span class="n">PublicKeyToken</span><span class="p">=</span><span class="k">null</span><span class="err">&#39;</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2010/05/02/working-with-default-filters-in-ms-crm-report-files/">Working With Default Filters in MS CRM Report Files</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2010-05-02T19:32:27-07:00" pubdate data-updated="true">May 2<span>nd</span>, 2010</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As you are probably aware, Microsoft CRM uses Sql Server Reporting services under the hood to run reports against CRM data. However, to allow more flexibility than would ordinarily be provided by SRSS alone Microsoft has several tricks up its sleeve when it comes to running the reports under CRM. To allow reports to run in different CRM contexts, dataset queries can be written in a way that CRM can rewrite the query to report contextually on selected rows or active view filters. That behavior is well covered elsewhere on the web so I probably won&#8217;t cover it here.</p>

<p>What I want to talk about here are default filters, which are added to the report when the .rdl file is uploaded to CRM. This filter persists as extended data addedÂ to the report file when downloaded from CRM.</p>

<p>By default, the data is filtered to show only the last 30 days&#8217; worth of records. Downloading a report from CRM and comparing it with the originally uploaded .rdl file, we can see that the following chunk gets added to the .rdl file:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;CustomProperties&gt;</span>
</span><span class='line'>  <span class="nt">&lt;CustomProperty&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Name&gt;</span>Custom<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Value&gt;</span><span class="ni">&amp;lt;</span>MSCRM xmlns=&quot;mscrm&quot;<span class="ni">&amp;gt;&amp;amp;</span>lt;ReportFilter<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>
</span><span class='line'>lt;ReportEntity paramname=
</span><span class='line'>&quot;P1&quot;<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;fetch version=&quot;1.0&quot; output-format=&quot;xml-platform&quot; mapping=&quot;logical&quot; distinct=&quot;false&quot;<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;entity name=&quot;contract&quot;<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;all-attributes /<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;filter type=&quot;and&quot;<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;condition attribute=&quot;modifiedon&quot;
</span><span class='line'>operator=&quot;last-x-days&quot; value=&quot;30&quot; /<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/filter<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/entity
</span><span class='line'><span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/
</span><span class='line'>fetch<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/
</span><span class='line'>ReportEntity<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;ReportEntity paramname=&quot;CRM_Filteredcontract&quot;
</span><span class='line'><span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>
</span><span class='line'>lt;fetch version=&quot;1.0&quot; output-format=&quot;xml-platform&quot; mapping=&quot;logical&quot; distinct=&quot;false&quot;<span class="ni">&amp;amp;</span>gt;
</span><span class='line'><span class="ni">&amp;amp;</span>lt;entity name=&quot;contract&quot;<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;all-attributes /<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;filter type=&quot;and&quot;<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;
</span><span class='line'>condition attribute=&quot;modifiedon&quot; operator=&quot;last-x-days&quot; value=&quot;30&quot; /<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/filter<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/entity<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/
</span><span class='line'>fetch<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/
</span><span class='line'>ReportEntity<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;amp;</span>lt;/ReportFilter<span class="ni">&amp;amp;</span>gt;<span class="ni">&amp;lt;</span>/MSCRM<span class="ni">&amp;gt;</span><span class="nt">&lt;/Value&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/CustomProperty&gt;</span>
</span><span class='line'><span class="nt">&lt;/CustomProperties&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yuck. Unfortunately, since the report filter is an embedded xml document, it must be escaped in order for CRM to import it correctly. It would be nice if we could format this so that it is easy to edit. At first blush it seems the a simple CDATA section should do the trick. However, the data is actually escaped twice, which requires nested CDATA sections, which are not allowed in the XML standard. What can we do? Fortunately we can embed the CDATA sections so that when the data is unescaped the first time, the second CDATA section remains intact.</p>

<p>The first thing to do is to recover the plain XML markup from the escaped text. I used a tool called <a href="http://xmlstar.sourceforge.net/">XMLStarlet</a>, but anything that can unescape XML entity references will do the trick.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat crm.xml | xmlstarlet unesc | xmlstarlet unesc
</span></code></pre></td></tr></table></div></figure>


<p>Gives us something like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;CustomProperties&gt;</span>
</span><span class='line'>  <span class="nt">&lt;CustomProperty&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Name&gt;</span>Custom<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Value&gt;</span>
</span><span class='line'>      <span class="nt">&lt;MSCRM</span> <span class="na">xmlns=</span><span class="s">&quot;mscrm&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;ReportFilter&gt;</span>
</span><span class='line'>          <span class="nt">&lt;ReportEntity</span> <span class="na">paramname=</span><span class="s">&quot;P1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;fetch</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span> <span class="na">output-format=</span><span class="s">&quot;xml-platform&quot;</span> <span class="na">mapping=</span><span class="s">&quot;logical&quot;</span> <span class="na">distinct=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;contract&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;all-attributes/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;filter</span> <span class="na">type=</span><span class="s">&quot;and&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;condition</span> <span class="na">attribute=</span><span class="s">&quot;modifiedon&quot;</span> <span class="na">operator=</span><span class="s">&quot;last-x-days&quot;</span> <span class="na">value=</span><span class="s">&quot;30&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/filter&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/entity&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/fetch&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/ReportEntity&gt;</span>
</span><span class='line'>          <span class="nt">&lt;ReportEntity</span> <span class="na">paramname=</span><span class="s">&quot;CRM_Filteredcontract&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;fetch</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span> <span class="na">output-format=</span><span class="s">&quot;xml-platform&quot;</span> <span class="na">mapping=</span><span class="s">&quot;logical&quot;</span> <span class="na">distinct=</span><span class="s">&quot;false&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>              <span class="nt">&lt;entity</span> <span class="na">name=</span><span class="s">&quot;contract&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;all-attributes/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;filter</span> <span class="na">type=</span><span class="s">&quot;and&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                  <span class="nt">&lt;condition</span> <span class="na">attribute=</span><span class="s">&quot;modifiedon&quot;</span> <span class="na">operator=</span><span class="s">&quot;last-x-days&quot;</span> <span class="na">value=</span><span class="s">&quot;30&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>                <span class="nt">&lt;/filter&gt;</span>
</span><span class='line'>              <span class="nt">&lt;/entity&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/fetch&gt;</span>
</span><span class='line'>          <span class="nt">&lt;/ReportEntity&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/ReportFilter&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/MSCRM&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Value&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/CustomProperty&gt;</span>
</span><span class='line'><span class="nt">&lt;/CustomProperties&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to work correctly when uploading the default filter, we escape it with CDATA tags like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;CustomProperties&gt;</span>
</span><span class='line'>  <span class="nt">&lt;CustomProperty&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Name&gt;</span>Custom<span class="nt">&lt;/Name&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Value&gt;</span><span class="cp">&lt;![CDATA[</span>
</span><span class='line'><span class="cp">      &lt;MSCRM xmlns=&quot;mscrm&quot;&gt;&lt;![CDATA[</span>
</span><span class='line'><span class="cp">        &lt;ReportFilter&gt;</span>
</span><span class='line'><span class="cp">          &lt;ReportEntity paramname=&quot;P1&quot;&gt;</span>
</span><span class='line'><span class="cp">            &lt;fetch version=&quot;1.0&quot; output-format=&quot;xml-platform&quot; mapping=&quot;logical&quot; distinct=&quot;false&quot;&gt;</span>
</span><span class='line'><span class="cp">              &lt;entity name=&quot;contract&quot;&gt;</span>
</span><span class='line'><span class="cp">                &lt;all-attributes/&gt;</span>
</span><span class='line'><span class="cp">                &lt;filter type=&quot;and&quot;&gt;</span>
</span><span class='line'><span class="cp">                  &lt;condition attribute=&quot;modifiedon&quot; operator=&quot;last-x-days&quot; value=&quot;30&quot;/&gt;</span>
</span><span class='line'><span class="cp">                &lt;/filter&gt;</span>
</span><span class='line'><span class="cp">              &lt;/entity&gt;</span>
</span><span class='line'><span class="cp">            &lt;/fetch&gt;</span>
</span><span class='line'><span class="cp">          &lt;/ReportEntity&gt;</span>
</span><span class='line'><span class="cp">          &lt;ReportEntity paramname=&quot;CRM_Filteredcontract&quot;&gt;</span>
</span><span class='line'><span class="cp">            &lt;fetch version=&quot;1.0&quot; output-format=&quot;xml-platform&quot; mapping=&quot;logical&quot; distinct=&quot;false&quot;&gt;</span>
</span><span class='line'><span class="cp">              &lt;entity name=&quot;contract&quot;&gt;</span>
</span><span class='line'><span class="cp">                &lt;all-attributes/&gt;</span>
</span><span class='line'><span class="cp">                &lt;filter type=&quot;and&quot;&gt;</span>
</span><span class='line'><span class="cp">                  &lt;condition attribute=&quot;modifiedon&quot; operator=&quot;last-x-days&quot; value=&quot;30&quot;/&gt;</span>
</span><span class='line'><span class="cp">                &lt;/filter&gt;</span>
</span><span class='line'><span class="cp">              &lt;/entity&gt;</span>
</span><span class='line'><span class="cp">            &lt;/fetch&gt;</span>
</span><span class='line'><span class="cp">          &lt;/ReportEntity&gt;</span>
</span><span class='line'><span class="cp">        &lt;/ReportFilter&gt;]]]]&gt;&lt;![CDATA[&gt;</span>
</span><span class='line'><span class="cp">      &lt;/MSCRM&gt;]]&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Value&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/CustomProperty&gt;</span>
</span><span class='line'><span class="nt">&lt;/CustomProperties&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we are free to edit the filter easily and when the .rdl file is uploaded, the changes to the filter will take effect.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/7/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2011/11/21/debugging-microsoft-crm-generic-sql-error/">Debugging Microsoft CRM &#8220;Generic SQL Error&#8221;</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/17/loading-configuration-from-an-alternative-location-in-microsoft-net/">Loading configuration from an alternative location in Microsoft .NET</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/17/configuration-types-in-microsoft-net/">Configuration types in Microsoft .NET</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/17/programmatically-creating-crm-4-entity-metadata/">Programmatically creating CRM 4 entity metadata</a>
      </li>
    
      <li class="post">
        <a href="/2011/11/16/configuration-patterns-in-net/">Configuration patterns in .NET</a>
      </li>
    
  </ul>
</section>






  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - Dan Newcome -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'crmvoyager';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
